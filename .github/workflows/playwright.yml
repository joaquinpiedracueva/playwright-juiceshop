name: Playwright Tests
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    services:
      juice-shop:
        image: bkimminich/juice-shop:v16.0.1
        ports:
          - 3000:3000
    strategy:
      matrix:
        shard: [1/2, 2/2]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test --shard=${{ matrix.shard }}
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: blob-report-${{ strategy.job-index }}
          path: blob-report/
          retention-days: 1

  merge-reports:
    if: ${{ !cancelled() }}
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm ci
      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          pattern: blob-report-*
          path: all-blob-reports
          merge-multiple: true
      - name: Merge reports
        run: npx playwright merge-reports --reporter=html ./all-blob-reports
      - uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  deploy-report:
    if: ${{ !cancelled() }}
    needs: [test, merge-reports]
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-reports
      cancel-in-progress: false
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 1

      - name: Download merged report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: new-report/

      - name: Copy report and write metadata
        run: |
          FULL_SHA="${{ github.event.pull_request.head.sha || github.sha }}"
          SHORT_SHA="${FULL_SHA:0:7}"
          REPORT_DIR="${SHORT_SHA}-${{ github.run_number }}"
          echo "REPORT_DIR=${REPORT_DIR}" >> "$GITHUB_ENV"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            BRANCH="${{ github.ref_name }}"
            PR_NUMBER=""
          fi

          COMMIT_MSG=$(git -C main-repo log -1 --format='%s' "$FULL_SHA" 2>/dev/null || echo "")

          mkdir -p "gh-pages/reports/${REPORT_DIR}"
          cp -r new-report/* "gh-pages/reports/${REPORT_DIR}/"

          jq -n \
            --arg id "$REPORT_DIR" \
            --arg sha "$FULL_SHA" \
            --arg shortSha "$SHORT_SHA" \
            --arg branch "$BRANCH" \
            --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg runNumber "${{ github.run_number }}" \
            --arg runId "${{ github.run_id }}" \
            --arg prNumber "$PR_NUMBER" \
            --arg event "${{ github.event_name }}" \
            --arg commitMessage "$COMMIT_MSG" \
            --arg result "${{ needs.test.result }}" \
            '{
              id: $id,
              sha: $sha,
              shortSha: $shortSha,
              branch: $branch,
              date: $date,
              runNumber: ($runNumber | tonumber),
              runId: ($runId | tonumber),
              prNumber: (if $prNumber == "" then null else ($prNumber | tonumber) end),
              event: $event,
              commitMessage: $commitMessage,
              result: $result
            }' > "gh-pages/reports/${REPORT_DIR}/metadata.json"

      - name: Update manifest and prune old reports
        run: |
          cd gh-pages
          mkdir -p reports
          touch reports/manifest.json

          # Build new manifest from all metadata files, sorted by date descending
          find reports -maxdepth 2 -name "metadata.json" -type f -exec cat {} + \
            | jq -s 'sort_by(.date) | reverse' > reports/manifest.tmp.json

          # Keep only the 10 most recent reports, prune the rest
          jq -r '.[10:][] | .id' reports/manifest.tmp.json | while IFS= read -r old_id; do
            echo "Pruning old report: $old_id"
            rm -rf "reports/${old_id}"
          done

          jq '.[0:10]' reports/manifest.tmp.json > reports/manifest.json
          rm -f reports/manifest.tmp.json

      - name: Copy landing page assets
        run: cp main-repo/.github/pages/index.html main-repo/.github/pages/styles.css main-repo/.github/pages/script.js gh-pages/

      - name: Push to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Deploy report ${REPORT_DIR}"
            git push origin gh-pages
          fi
